pipeline {
  agent any

  environment {
    HARBOR_ADDRESS = 'registry.cn-hangzhou.aliyuncs.com'
    HARBOR_PROJECT = 'tianxiang_app'
    DEPLOY_USER = 'root'  // è¿œç¨‹æœåŠ¡å™¨çš„éƒ¨ç½²ç”¨æˆ·
    APP_PORT = '8081'
  }

  tools {
    maven 'maven-3.6.3'  // è¿™é‡Œä½¿ç”¨æ‚¨åœ¨ Jenkins ä¸­é…ç½®çš„ Maven åç§°
    jdk 'java-17'        // é€‰æ‹©é¡¹ç›®è¦ä½¿ç”¨çš„ jdk ç¯å¢ƒ
  }

  parameters {
    // BRANCH_NAME æ”¯æŒä»»æ„åˆ†æ”¯åï¼Œå¦‚ï¼šdevã€dev-feature-xã€test-apiã€pro-release-1.0 ç­‰
    string(
      name: 'BRANCH_NAME',
      defaultValue: 'dev',
      description: 'è¯·è¾“å…¥è¦æ„å»ºçš„ Git åˆ†æ”¯ï¼Œä¾‹å¦‚ï¼šdev / dev-feature-x / test-api / pro-release-1.0'
    )

      string(
        name: 'JAR_PATH',
        defaultValue: '',
        description: 'Jar åŒ…ç›¸å¯¹è·¯å¾„ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™è‡ªåŠ¨è¯†åˆ«ï¼Œé€‚ç”¨äºéæ ‡å‡†/å¤šæ¨¡å—é¡¹ç›®ï¼‰'
      )

    string(
      name: 'HARBOR_PROJECT',
      defaultValue: '',
      description: 'Harbor é¡¹ç›®åï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤ç¯å¢ƒå˜é‡ HARBOR_PROJECTï¼‰'
    )

    string(
      name: 'IMAGE_NAME',
      defaultValue: '',
      description: 'Docker é•œåƒåç§°ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™é»˜è®¤ä½¿ç”¨ Git ä»“åº“é¡¹ç›®åï¼‰'
    )
  }

  stages {
    stage('è§£æéƒ¨ç½²ç¯å¢ƒ') {
      steps {
        script {
          // ç»Ÿä¸€ã€éƒ¨ç½²ç¯å¢ƒã€‘åˆ°ä¸»æœº/å‡­æ®çš„æ˜ å°„
          def envConfig = [
            dev : [env: 'dev' , host: '10.100.4.120'              , sshId: 'ssh-10.100.4.120'],
            test: [env: 'test', host: 'test-server.tianxiang.love', sshId: 'test-ssh-key'],
            prod: [env: 'prod', host: 'prod-server.tianxiang.love', sshId: 'prod-ssh-key'],
          ]

          def branch = params.BRANCH_NAME?.trim()
          if (!branch) {
            error "BRANCH_NAME ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥è¦æ„å»ºçš„ Git åˆ†æ”¯ï¼Œä¾‹å¦‚ dev / dev-feature-x / test-api / pro-release"
          }

          // æ ¹æ® BRANCH_NAME å‰ç¼€è‡ªåŠ¨æ¨æ–­éƒ¨ç½²ç¯å¢ƒ
          // è§„åˆ™ç¤ºä¾‹ï¼š
          //   devã€dev-xxx        -> dev ç¯å¢ƒ
          //   testã€test-xxx      -> test ç¯å¢ƒ
          //   proã€pro-xxx        -> prod ç¯å¢ƒ
          //   prodã€prod-xxx      -> prod ç¯å¢ƒ
          String envKey
          if (branch ==~ /^dev(-.*)?$/) {
            envKey = 'dev'
          } else if (branch ==~ /^test(-.*)?$/) {
            envKey = 'test'
          } else if (branch ==~ /^(pro|prod)(-.*)?$/) {
            envKey = 'prod'
          } else {
            error "æ— æ³•æ ¹æ® BRANCH_NAME='${branch}' æ¨æ–­éƒ¨ç½²ç¯å¢ƒï¼Œè¯·ä½¿ç”¨ dev/dev-ã€test/test-ã€pro/prod/pro-/prod- ä½œä¸ºå‰ç¼€"
          }

          def cfg = envConfig[envKey]
          if (!cfg) {
            error "æœªæ‰¾åˆ°ç¯å¢ƒé…ç½®: envKey=${envKey}"
          }

          env.DEPLOY_ENV = cfg.env
          env.DEPLOY_HOST = cfg.host
          env.SSH_CREDENTIALS_ID = cfg.sshId

          echo "ğŸš€ è§£æéƒ¨ç½²ç¯å¢ƒå®Œæˆ: åˆ†æ”¯=${branch}, DEPLOY_ENV=${env.DEPLOY_ENV}"
          echo "ğŸŒ ç›®æ ‡æœåŠ¡å™¨: ${env.DEPLOY_HOST}"
          echo "ğŸ”— åº”ç”¨ç«¯å£: ${APP_PORT}"
        }
      }
    }

    stage('æ‹‰å–ä»£ç ') {
      steps {
        echo "ğŸ“¥ æ­£åœ¨æ‹‰å–åˆ†æ”¯: ${params.BRANCH_NAME}"
        git(url: 'https://k8s-gitlab.tianxiang.love/my-awesome-group/java-demo-project.git',
            branch: "${params.BRANCH_NAME}",
            credentialsId: '983874af-38db-4dfb-b9b2-e3d1df3446ba')

        script {
          env.GIT_SHORT_COMMIT = env.GIT_COMMIT.take(6)
          echo "âœ… å½“å‰ GIT_COMMIT(6ä½çŸ­å“ˆå¸Œ): ${env.GIT_SHORT_COMMIT}"

          // åŠ¨æ€è®¾ç½® HARBOR_PROJECT / IMAGE_NAMEï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å‚æ•°ï¼Œå…¶æ¬¡ä½¿ç”¨é»˜è®¤/ä»“åº“å
          def repoUrl = sh(returnStdout: true, script: 'git config --get remote.origin.url').trim()
          def repoPath = repoUrl
          if (repoUrl.contains('://')) {
            repoPath = repoUrl.split('://', 2)[1]
          }
          if (!repoUrl.contains('://') && repoPath.contains(':')) {
            // å…¼å®¹ git@host:group/repo.git
            repoPath = repoPath.split(':', 2)[1]
          }
          def repoName = repoPath.tokenize('/')?.last()
          repoName = repoName?.trim().replaceAll(/\.git$/, '')

          env.HARBOR_PROJECT = params.HARBOR_PROJECT?.trim() ? params.HARBOR_PROJECT.trim() : env.HARBOR_PROJECT
          env.IMAGE_NAME = params.IMAGE_NAME?.trim() ? params.IMAGE_NAME.trim() : repoName

          if (!env.IMAGE_NAME?.trim()) {
            error "æ— æ³•æ¨æ–­ IMAGE_NAMEï¼ˆrepoUrl=${repoUrl}ï¼‰ï¼Œè¯·åœ¨å‚æ•° IMAGE_NAME ä¸­æ‰‹åŠ¨æŒ‡å®š"
          }

          echo "ğŸ“¦ æœ€ç»ˆé•œåƒä¿¡æ¯: HARBOR_PROJECT=${env.HARBOR_PROJECT}, IMAGE_NAME=${env.IMAGE_NAME}"
        }
      }
    }

    stage('æ„å»ºJaråŒ…') {
      steps {
        script {
          // 1ï¸âƒ£ ç¡®å®š Maven Profile
          def mvnProfile = (env.DEPLOY_ENV == 'prod') ? 'prod' : 'dev'
          echo "ğŸ—ï¸ ä½¿ç”¨ Maven Profile: ${mvnProfile}"

          // 2ï¸âƒ£ Maven æ„å»º
          sh "mvn -B clean package -P ${mvnProfile} -Dmaven.test.skip=true"

          echo "ğŸ“¦ ç¡®å®š Jar æ„å»ºäº§ç‰©..."

          // 3ï¸âƒ£ ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ JAR_PATH
          if (params.JAR_PATH?.trim()) {
            env.JAR_PATH = params.JAR_PATH.trim()

            if (!fileExists(env.JAR_PATH)) {
              error "âŒ æŒ‡å®šçš„ JAR_PATH ä¸å­˜åœ¨: ${env.JAR_PATH}"
            }

            echo "âœ… ä½¿ç”¨ç”¨æˆ·æŒ‡å®š Jar: ${env.JAR_PATH}"
          }
          // 4ï¸âƒ£ Maven å®˜æ–¹æ–¹å¼è§£æï¼ˆæœ€ç¨³ï¼‰
          else {
            def buildDir = sh(
              returnStdout: true,
              script: 'mvn -q help:evaluate -Dexpression=project.build.directory -DforceStdout 2>/dev/null || true'
            ).trim()

            def finalName = sh(
              returnStdout: true,
              script: 'mvn -q help:evaluate -Dexpression=project.build.finalName -DforceStdout 2>/dev/null || true'
            ).trim()

            if (buildDir && finalName && fileExists("${buildDir}/${finalName}.jar")) {
              env.JAR_PATH = "${buildDir}/${finalName}.jar"
              echo "âœ… ä½¿ç”¨ Maven æ„å»ºäº§ç‰©: ${env.JAR_PATH}"
            }
            // 5ï¸âƒ£ å…œåº•ï¼šå…¨ä»“åº“æ‰«æï¼ˆå¤šæ¨¡å— / éæ ‡å‡†ï¼‰
            else {
              echo "ğŸ”„ Maven è§£æå¤±è´¥ï¼Œæ‰§è¡Œå…¨ä»“åº“æ‰«æ..."

              env.JAR_PATH = sh(
                returnStdout: true,
                script: '''
                  find . -type f -name "*.jar" \
                    ! -name "*-sources.jar" \
                    ! -name "*-javadoc.jar" \
                    ! -name "original-*.jar" \
                  | xargs ls -lh \
                  | sort -k5 -h \
                  | tail -n 1 \
                  | awk '{print $NF}'
                '''
              ).trim()

              if (!env.JAR_PATH || !fileExists(env.JAR_PATH)) {
                error "âŒ æ— æ³•è‡ªåŠ¨è¯†åˆ« Jar åŒ…ï¼Œè¯·é€šè¿‡ JAR_PATH å‚æ•°æ‰‹åŠ¨æŒ‡å®š"
              }

              echo "âœ… è‡ªåŠ¨è¯†åˆ«ä¸» Jar: ${env.JAR_PATH}"
            }
          }

          // 6ï¸âƒ£ æœ€ç»ˆç¡®è®¤ï¼ˆæ–¹ä¾¿æ’éšœï¼‰
          sh "ls -lh ${env.JAR_PATH}"
        }
      }
    }

    stage('ç”ŸæˆTAGæ ‡ç­¾') {
      steps {
        script {
          def dateTag = sh(returnStdout: true, script: 'date +%Y-%m-%d-%H-%M').trim()
          env.TAG_NAME = "${params.BRANCH_NAME}-${dateTag}-${env.GIT_SHORT_COMMIT}-${BUILD_NUMBER}"
          env.IMAGE_FULL_NAME = "$HARBOR_ADDRESS/$HARBOR_PROJECT/$IMAGE_NAME:${env.TAG_NAME}"
          echo "âœ… ç”Ÿæˆçš„ TAG_NAME: ${env.TAG_NAME}"
        }
      }
    }

    stage('Docker Build & Push é•œåƒ') {
      steps {
        script {
          echo "ç™»å½• Harbor ä»“åº“"
          // ä½¿ç”¨ withCredentials åŒ…è£…éœ€è¦å¯†ç çš„æ­¥éª¤
          withCredentials([usernamePassword(
            credentialsId: 'harbor-credentials',
            usernameVariable: 'HARBOR_USER',
            passwordVariable: 'HARBOR_PASSWD'
          )]) {
            sh "echo \"$HARBOR_PASSWD\" | docker login $HARBOR_ADDRESS -u \"$HARBOR_USER\" --password-stdin"

            echo "æ„å»ºé•œåƒ: ${env.IMAGE_FULL_NAME}"

            // å°†ç»å¯¹è·¯å¾„è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆDocker build contextéœ€è¦ï¼‰
            def jarRelativePath = sh(
              returnStdout: true,
              script: "realpath --relative-to=. ${env.JAR_PATH}"
            ).trim()

            echo "ğŸ“¦ Docker JAR_FILE å‚æ•°: ${jarRelativePath}"

            sh """
              docker build \\
                --build-arg JAR_FILE=${jarRelativePath} \\
                --build-arg PROFILE=${env.DEPLOY_ENV} \\
                --build-arg PORT=${APP_PORT} \\
                -t ${env.IMAGE_FULL_NAME} .
            """

            echo "æ¨é€é•œåƒä¸­..."
            sh "docker push ${env.IMAGE_FULL_NAME}"
            echo "âœ… é•œåƒæ¨é€æˆåŠŸ: ${env.IMAGE_FULL_NAME}"
          }
        }
      }
    }

    stage('ç”Ÿæˆéƒ¨ç½²æ–‡ä»¶') {
      steps {
        script {
          // å®‰è£…envsubstå·¥å…·ï¼ˆå¦‚æœéœ€è¦ï¼‰
          sh '''
            if ! command -v envsubst &> /dev/null; then
              echo "å®‰è£…envsubst..."
              if command -v yum &> /dev/null; then
                sudo yum install -y gettext
              elif command -v apt-get &> /dev/null; then
                sudo apt-get install -y gettext
              fi
            fi
          '''

          // æ‰§è¡Œç”Ÿæˆéƒ¨ç½²æ–‡ä»¶çš„è„šæœ¬
          sh """
            if [ -f "jenkins/scripts/generate-deploy-files.sh" ]; then
              chmod +x jenkins/scripts/generate-deploy-files.sh
              jenkins/scripts/generate-deploy-files.sh ${env.DEPLOY_ENV} ${env.IMAGE_FULL_NAME}
            else
              echo "âš ï¸  ç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ–‡ä»¶ç”Ÿæˆ"
            fi
          """

          // æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          sh 'ls -la start-app/ 2>/dev/null || echo "start-appç›®å½•ä¸å­˜åœ¨"'
        }
      }
    }

    stage('SSHè¿œç¨‹éƒ¨ç½²ï¼ˆç®€å•ç‰ˆï¼‰') {
      steps {
        script {
          echo "ğŸ”— è¿æ¥è¿œç¨‹æœåŠ¡å™¨ ${env.DEPLOY_HOST}"

          sshagent(credentials: [env.SSH_CREDENTIALS_ID]) {
            // ä¸Šä¼  docker-compose æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨
            sh """
              ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${env.DEPLOY_HOST} \\
                "mkdir -p /opt/apps/${IMAGE_NAME}/start-app"

              scp -o StrictHostKeyChecking=no start-app/docker-compose.yml \\
                ${DEPLOY_USER}@${env.DEPLOY_HOST}:/opt/apps/${IMAGE_NAME}/start-app/ 2>/dev/null || echo "docker-compose.ymlä¸å­˜åœ¨"
            """

            // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œ docker-compose éƒ¨ç½²ï¼Œä¸åšè‡ªåŠ¨å›æ»šå’Œå¤æ‚å¥åº·æ£€æŸ¥
            sh """
              ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${env.DEPLOY_HOST} \\
                "cd /opt/apps/${IMAGE_NAME}/start-app && \\
                 docker-compose pull || docker-compose pull || true && \\
                 docker-compose up -d || docker-compose up -d && \\
                 docker-compose ps || docker-compose ps"
            """
          }

          echo "âœ… è¿œç¨‹éƒ¨ç½²å®Œæˆï¼ˆå¦‚éœ€è¿›ä¸€æ­¥å¥åº·æ£€æŸ¥ï¼Œå¯åœ¨æœåŠ¡å™¨ä¸Šè‡ªè¡Œ curl/æŸ¥çœ‹æ—¥å¿—ï¼‰"
        }
      }
    }
  }

  post {
    success {
      echo "ğŸ‰ æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
      script {
        currentBuild.description = "âœ… ${env.DEPLOY_ENV} - ${env.TAG_NAME}"
      }
    }

    failure {
      echo "âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
      script {
        currentBuild.description = "âŒ ${env.DEPLOY_ENV} - ${env.TAG_NAME}"
      }
    }
  }
}