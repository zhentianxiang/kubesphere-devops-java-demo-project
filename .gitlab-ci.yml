stages:
  - package
  - docker_build
  - deploy_k8s

variables:
  GIT_DEPTH: 0    # å®Œæ•´å…‹éš†ä»£ç 
  MAVEN_OPTS: "-Dmaven.repo.local=${CI_PROJECT_DIR}/.cache/maven"      # Maven ç¼“å­˜

# å…¨å±€ç¼“å­˜é…ç½®ï¼ˆæ‰€æœ‰ job ç»§æ‰¿ï¼‰
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/maven   # å…¨å±€ç¼“å­˜ .cache ç›®å½•
  policy: pull-push

before_script:
  - mkdir -p .cache/maven/jar/
  - export MAVEN_OPTS="-Dmaven.repo.local=${CI_PROJECT_DIR}/.cache/maven"
  - export PATH=/usr/local/apache-maven-3.6.3/bin:$PATH

mvn_build_job:
  image: harbor.tianxiang.love/library/maven-3.6.3-jdk-21:latest
  stage: package
  tags:
    - k8s-runner
  script:
    # åŠ¨æ€æ„å»ºæ¨¡å¼
    - |
      if [[ "$CI_COMMIT_BRANCH" =~ ^pre.* ]]; then
        PROFILE=pre
      elif [[ "$CI_COMMIT_BRANCH" =~ ^dev.* ]]; then
        PROFILE=dev
      elif [[  "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" =~ ^prod.* ]]; then
        PROFILE=prod
      fi

    # maven æ„å»ºå¹¶æŒ‡å®šç¼“å­˜ç›®å½•
    - mvn -B clean install -P${PROFILE} -Dmaven.test.skip=true #-Dmaven.repo.local=.cache/maven

    # åŠ¨æ€è·å– JAR äºŒè¿›åˆ¶æ–‡ä»¶å
    - JAR_NAME=$(find target -maxdepth 1 -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" ! -name "original-*" | head -n 1)

    - ls $JAR_NAME
    # åˆ›å»ºç¼“å­˜ JAR äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•
    - cp $JAR_NAME .cache/maven/jar/

    # éªŒè¯ç¼“å­˜æ˜¯å¦æˆ
    - ls -lah .cache/maven/jar/

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^pre.*/' # åŒ¹é… pre å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ pre-2025-05-15
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^dev.*/'  # åŒ¹é… dev å¼€å¤´çš„åˆ†æ”¯
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'   # åªåŒ¹é… main åˆ†æ”¯
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^prod.*/' # åŒ¹é… prod å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ prod-2025-05-15
      when: on_success


docker_build_job:
  image: harbor.tianxiang.love/library/docker:latest
  stage: docker_build
  tags:
    - k8s-runner
  script:
    # éªŒè¯ä¸Šä¸ªé˜¶æ®µçš„æ„å»ºäº§ç‰©æ˜¯å¦åœ¨æœ¬é˜¶æ®µå­˜åœ¨
    - ls -lah .cache/maven/jar/

    # ä»ç¼“å­˜ä¸­åŠ¨æ€è·å– JAR æ–‡ä»¶å
    - JAR_NAME=$(ls $(pwd)/.cache/maven/jar/*.jar)

    # å¤åˆ¶ JAR æ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½• target ç›®å½•ä¸­ä»¥å¤‡ Dockerfile ä½¿ç”¨
    - mkdir -p target

    - cp $JAR_NAME target/

    # å®šä¹‰ k8s éƒ¨ç½²é¡¹ç›®åç§°
    - PROJECT_NAME="k8s-app"

    # å®šä¹‰é•œåƒåç§°
    - IMAGE_NAME="java-demon-project"

    # ç”Ÿæˆé•œåƒæ ‡ç­¾
    - TAG_NAME="${CI_COMMIT_REF_NAME}-$(date +%Y-%m-%d-%H-%M)-${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_ID}"

    # åŠ¨æ€æ„å»ºæ¨¡å¼
    - |
      if [[ "$CI_COMMIT_BRANCH" =~ ^pre.* ]]; then
         PROFILE=pre
         HARBOR_ADDRESS=harbor.meta42-uat.com
         # é¢„ç”Ÿäº§ç¯å¢ƒ Docker è®¤è¯
         mkdir -pv ~/.docker/
         echo $PRE_DOCKER_AUTH_CONFIG | base64 -d > ~/.docker/config.json
         # é…ç½® docker ca è¯ä¹¦
         mkdir -pv /etc/docker/certs.d/harbor.tianxiang.love
         echo $PRE_DOCKER_CA | base64 -d > /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         cat /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         ENV_DESC="é¢„ç”Ÿäº§ç¯å¢ƒ"
      elif [[ "$CI_COMMIT_BRANCH" =~ ^dev.* ]]; then
        PROFILE=dev
         HARBOR_ADDRESS=harbor.tianxiang.love
         # å¼€å‘ç¯å¢ƒ Docker è®¤è¯
         mkdir -pv ~/.docker/
         echo $DEV_DOCKER_AUTH_CONFIG | base64 -d > ~/.docker/config.json
         # é…ç½® docker ca è¯ä¹¦
         mkdir -pv /etc/docker/certs.d/harbor.tianxiang.love
         echo $DEV_DOCKER_CA | base64 -d > /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         cat /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         ENV_DESC="å¼€å‘ç¯å¢ƒ"
      elif [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" =~ ^prod.* ]]; then
         PROFILE=prod
         HARBOR_ADDRESS=harbor.tianxiang.love
         # ç”Ÿäº§ç¯å¢ƒ Docker è®¤è¯
         mkdir -pv ~/.docker/
         echo $PROD_DOCKER_AUTH_CONFIG | base64 -d > ~/.docker/config.json
         # é…ç½® docker ca è¯ä¹¦
         mkdir -pv /etc/docker/certs.d/harbor.tianxiang.love
         echo $PROD_DOCKER_CA | base64 -d > /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         cat /etc/docker/certs.d/harbor.tianxiang.love/ca.crt
         ENV_DESC="ç”Ÿäº§ç¯å¢ƒ"
      else
      echo "âŒ æœªè¯†åˆ«çš„åˆ†æ”¯ï¼Œæ„å»ºç»ˆæ­¢"
      exit 1
      fi
    - |
      cat <<EOF > .cache/maven/.ENV_FILE.env
      PROJECT_NAME=$PROJECT_NAME
      IMAGE_NAME=$IMAGE_NAME
      TAG_NAME=$TAG_NAME
      HARBOR_ADDRESS=$HARBOR_ADDRESS
      EOF
    - cat .cache/maven/.ENV_FILE.env
    - echo "åˆ¶ä½œé•œåƒ $IMAGE_NAME:$TAG_NAME åˆ°$ENV_DESC"
    - ls -la /etc/docker/certs.d/
    - ls -la /etc/docker/certs.d/*/
    - docker login $HARBOR_ADDRESS
    - docker pull harbor.tianxiang.love/library/jdk-8u421:v1.8.0_421
    - docker build --build-arg PROFILE=$PROFILE -t $HARBOR_ADDRESS/$PROJECT_NAME/$IMAGE_NAME:$TAG_NAME .
    - docker push $HARBOR_ADDRESS/$PROJECT_NAME/$IMAGE_NAME:$TAG_NAME
    - MSG="âœ… å·²æ¨é€é•œåƒ \"$HARBOR_ADDRESS/$PROJECT_NAME/$IMAGE_NAME:$TAG_NAME\" åˆ°$ENV_DESC"
    - echo "$MSG"
    - docker rmi $HARBOR_ADDRESS/$PROJECT_NAME/$IMAGE_NAME:$TAG_NAME

  artifacts:
    paths:
      - .cache/maven/.ENV_FILE.env
    expire_in: 1 week

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^pre.*/' # åŒ¹é… pre å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ pre-2025-05-15
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^dev.*/'  # åŒ¹é… dev å¼€å¤´çš„åˆ†æ”¯
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'   # åªåŒ¹é… main åˆ†æ”¯
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^prod.*/' # åŒ¹é… prod å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ prod-2025-05-15
      when: on_success

deploy_k8s_job:
  image: harbor.tianxiang.love/library/kubectl:v1.23.0
  stage: deploy_k8s
  tags:
    - k8s-runner
  script:
    - mkdir -pv ~/.kube/
    - ls -lh
    # åŠ è½½ç¼“å­˜ä¸­çš„é•œåƒä¿¡æ¯å˜é‡
    - source .cache/maven/.ENV_FILE.env
    - |
      if [[ "$CI_COMMIT_BRANCH" =~ ^pre.* ]]; then
        echo 'éƒ¨ç½²æœåŠ¡åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ'
        PROFILE=pre
        echo "$PRE_KUBE_CONFIG" | base64 -d > ~/.kube/config
        echo '192.168.233.246 apiserver.cluster.local' | tee -a /etc/hosts
        sed -e "s/{{.IMAGE_NAME}}/$IMAGE_NAME/g" \
            -e "s/{{.PROJECT_NAME}}/$PROJECT_NAME/g" \
            -e "s/{{.TAG_NAME}}/$TAG_NAME/g" \
            -e "s/{{.HARBOR_ADDRESS}}/$HARBOR_ADDRESS/g" \
            -e"s/{{.PROFILE}}/$PROFILE/g" \
               k8s/deployment-pre.tml > k8s/deployment-pre.yaml
        cat k8s/deployment-pre.yaml

        # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
        DEPLOY_START_TIME=$(date +%s)
        echo "DEPLOY_START_TIME=$DEPLOY_START_TIME" > /tmp/deploy_time.env
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        kubectl apply -f k8s/deployment-pre.yaml

        # æ£€æŸ¥ pod å¯åŠ¨æƒ…å†µ
        bash ./scripts/wait-pod-running.sh "${HARBOR_PROJECT}" "${IMAGE_NAME}"

        grep -v '192.168.233.246 apiserver.cluster.local' /etc/hosts > /tmp/hosts && cat /tmp/hosts > /etc/hosts

      elif [[ "$CI_COMMIT_BRANCH" =~ ^dev.* ]]; then
        echo 'éƒ¨ç½²æœåŠ¡åˆ°å¼€å‘ç¯å¢ƒ'
        PROFILE=dev
        echo "$DEV_KUBE_CONFIG" | base64 -d > ~/.kube/config
        echo '192.168.198.51 dev-apiserver.cluster.local' | tee -a /etc/hosts
        sed -e "s/{{.IMAGE_NAME}}/$IMAGE_NAME/g" \
            -e "s/{{.PROJECT_NAME}}/$PROJECT_NAME/g" \
            -e "s/{{.TAG_NAME}}/$TAG_NAME/g" \
            -e "s/{{.HARBOR_ADDRESS}}/$HARBOR_ADDRESS/g" \
            -e "s/{{.PROFILE}}/$PROFILE/g" \
               k8s/deployment-dev.tml > k8s/deployment-dev.yaml
        cat k8s/deployment-dev.yaml

        # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
        DEPLOY_START_TIME=$(date +%s)
        echo "DEPLOY_START_TIME=$DEPLOY_START_TIME" > /tmp/deploy_time.env
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        kubectl apply -f k8s/deployment-dev.yaml
        
        # æ£€æŸ¥ pod å¯åŠ¨æƒ…å†µ
        bash ./scripts/wait-pod-running.sh "${HARBOR_PROJECT}" "${IMAGE_NAME}"

        grep -v '192.168.198.51 dev-apiserver.cluster.local' /etc/hosts > /tmp/hosts && cat /tmp/hosts > /etc/hosts

      elif [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" =~ ^prod.* ]]; then
        echo 'éƒ¨ç½²æœåŠ¡åˆ°ç”Ÿäº§ç¯å¢ƒ'
        PROFILE=prod
        echo "$PROD_KUBE_CONFIG" | base64 -d > ~/.kube/config
        echo '192.168.233.246 apiserver.cluster.local '  | tee -a /etc/hosts
        sed -e "s/{{.IMAGE_NAME}}/$IMAGE_NAME/g" \
            -e "s/{{.PROJECT_NAME}}/$PROJECT_NAME/g" \
            -e "s/{{.TAG_NAME}}/$TAG_NAME/g" \
            -e "s/{{.HARBOR_ADDRESS}}/$HARBOR_ADDRESS/g" \
            -e"s/{{.PROFILE}}/$PROFILE/g" \
               k8s/deployment-prod.tml > k8s/deployment-prod.yaml
        cat k8s/deployment-prod.yaml
      
        # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
        DEPLOY_START_TIME=$(date +%s)
        echo "DEPLOY_START_TIME=$DEPLOY_START_TIME" > /tmp/deploy_time.env
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        kubectl apply -f k8s/deployment-prod.yaml
        
        # æ£€æŸ¥ pod å¯åŠ¨æƒ…å†µ
        bash ./scripts/wait-pod-running.sh "${HARBOR_PROJECT}" "${IMAGE_NAME}"

        grep -v '192.168.233.246 apiserver.cluster.local ' /etc/hosts > /tmp/hosts && cat /tmp/hosts > /etc/hosts
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^pre.*/' # åŒ¹é… pre å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ pre-2025-05-15
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /^dev.*/'  # åŒ¹é… dev å¼€å¤´çš„åˆ†æ”¯
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'   # åªåŒ¹é… main åˆ†æ”¯
      when: manual  # æ‰‹åŠ¨è§¦å‘ main åˆ†æ”¯éƒ¨ç½²
    - if: '$CI_COMMIT_BRANCH =~ /^prod.*/' # åŒ¹é… prod å¼€å¤´çš„åˆ†æ”¯ï¼Œå¦‚ prod-2025-05-15
      when: manual  # æ‰‹åŠ¨è§¦å‘ prod å¼€å¤´çš„åˆ†æ”¯éƒ¨ç½²